---
name: Deploy updates

on:
  push:
    branches:
      - main

jobs:
  deploy-dev:
    env:
      ANTA_PASSWORD: ${{ secrets.ANTA_PASSWORD }}
      SUDO_PASS: ${{ secrets.SUDO_PASS }}

    timeout-minutes: 15
    runs-on: avd-ci
    steps:
      - name: hi
        run: echo "Hello World!"

      - name: checkout
        uses: actions/checkout@v4

      - name: setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: install requirements
        run: ./setup.sh

      - name: deploy topology with clab
        run: echo $SUDO_PASS | sudo -S clab deploy -t lab.yml --reconfigure

      - name: build with AVD
        run: ansible-playbook playbooks/build.yml

      - name: deploy to nodes
        run: |
          ansible-playbook playbooks/deploy-net.yml
          sleep 10

      - name: install ANTA and run tests
        run: |
          pip3 install anta
          anta \
              --username admin \
              --password $ANTA_PASSWORD \
              -i anta/anta-inv.yml \
              nrfu --catalog anta/anta-test.yml text

      - name: destroy lab
        if: always()
        run: echo $SUDO_PASS | sudo -S clab destroy -t lab.yml -c
